<!DOCTYPE html>
<html lang="kn">
<head>
<meta charset="UTF-8">
<title>Resonex Farmer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 12px;
  background: url("Background.jpg") no-repeat center/cover;
}

.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.form-row label {
  width: 35%;
  font-weight: bold;
  color: yellow;
  font-size: 14px;
}

.form-row input {
  width: 65%;
  padding: 10px;
  font-size: 14px;
  font-weight: bold;
}

button {
  width: 60%;
  margin: 12px auto;
  padding: 14px;
  font-size: 15px;
  font-weight: bold;
  background: #0a7a6a;
  color: white;
  border: none;
  border-radius: 6px;
  display: block;
}

canvas {
  width: 100%;
  max-width: 100%;
  margin-top: 15px;
  display: none;
  border: 3px solid #ccc;
}
</style>
</head>

<body>

<div class="form-row">
  <label>ರೈತರ ಹೆಸರು</label>
  <input id="name">
</div>

<div class="form-row">
  <label>ಮೊಬೈಲ್ ಸಂಖ್ಯೆ</label>
  <input id="mobile" inputmode="numeric" maxlength="10">
</div>

<div class="form-row">
  <label>ಗ್ರಾಮ</label>
  <input id="village">
</div>

<div class="form-row">
  <label>ಜಿಲ್ಲೆ</label>
  <input id="district">
</div>

<div class="form-row">
  <label>ಫೋಟೋ</label>
  <input type="file" id="photo" accept="image/*">
</div>

<button onclick="generate()">Preview</button>

<canvas id="canvas"></canvas>

<button onclick="downloadImage()" id="downloadBtn" style="display:none">
Download
</button>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = "high";

/* Load banner safely */
const banner = new Image();
banner.src = "BG.png";
let bannerLoaded = false;
banner.onload = () => bannerLoaded = true;

const photoBox = { x: 380, y: 170, w: 520, h: 420, r: 30 };

document.getElementById("mobile").addEventListener("input", e => {
  e.target.value = e.target.value.replace(/\D/g, "");
});

function roundedRect(x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

async function generate() {

  if (!bannerLoaded) {
    alert("Please wait, loading background...");
    return;
  }

  const name = document.getElementById("name").value.toUpperCase();
  const mobile = document.getElementById("mobile").value;
  const village = document.getElementById("village").value.toUpperCase();
  const district = document.getElementById("district").value.toUpperCase();
  const file = document.getElementById("photo").files[0];

  if (mobile.length !== 10) {
    alert("ದಯವಿಟ್ಟು 10 ಅಂಕಿಯ ಮೊಬೈಲ್ ಸಂಖ್ಯೆಯನ್ನು ನಮೂದಿಸಿ");
    return;
  }
  if (!file) {
    alert("ದಯವಿಟ್ಟು ಫೋಟೋ ಆಯ್ಕೆ ಮಾಡಿ");
    return;
  }

  const farmerImg = new Image();
  farmerImg.src = URL.createObjectURL(file);

  farmerImg.onload = async () => {

    /* FIXED CANVAS SIZE */
    canvas.width = banner.naturalWidth;
    canvas.height = banner.naturalHeight;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(banner, 0, 0);

    /* SHADOW CARD */
    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,0.35)";
    ctx.shadowBlur = 30;
    ctx.shadowOffsetY = 12;
    roundedRect(photoBox.x, photoBox.y, photoBox.w, photoBox.h, photoBox.r);
    ctx.fillStyle = "#fff";
    ctx.fill();
    ctx.restore();

    /* CLIP PHOTO */
    ctx.save();
    roundedRect(photoBox.x, photoBox.y, photoBox.w, photoBox.h, photoBox.r);
    ctx.clip();

    let drawX = farmerImg.width / 2;
    let drawY = farmerImg.height * 0.35;

    if ('FaceDetector' in window) {
      try {
        const detector = new FaceDetector({ fastMode: true });
        const faces = await detector.detect(farmerImg);
        if (faces.length) {
          const box = faces[0].boundingBox;
          drawX = box.x + box.width / 2;
          drawY = box.y + box.height / 2;
        }
      } catch {}
    }

    const scale = Math.max(
      photoBox.w / farmerImg.width,
      photoBox.h / farmerImg.height
    );

    ctx.drawImage(
      farmerImg,
      photoBox.x + photoBox.w / 2 - drawX * scale,
      photoBox.y + photoBox.h / 2 - drawY * scale,
      farmerImg.width * scale,
      farmerImg.height * scale
    );

    ctx.restore();

    /* BORDER */
    ctx.lineWidth = 6;
    ctx.strokeStyle = "#fff";
    roundedRect(photoBox.x, photoBox.y, photoBox.w, photoBox.h, photoBox.r);
    ctx.stroke();

    /* TEXT PANEL */
    const dx = 950;
    let dy = 260;

    ctx.fillStyle = "rgba(0,0,0,0.4)";
    ctx.fillRect(dx - 30, dy - 55, 450, 260);

    ctx.fillStyle = "#FFD700";
    ctx.font = "bold 30px Arial";
    ctx.fillText("ಕ್ರಾಂತಿಕಾರಿ ರೈತ", dx, dy);

    ctx.font = "bold 20px Arial";
    ctx.fillStyle = "#fff";
    dy += 50;
    ctx.fillText(`ರೈತ ಹೆಸರು :- ${name}`, dx, dy);
    dy += 40;
    ctx.fillText(`ಮೊಬೈಲ್ :- ${mobile}`, dx, dy);
    dy += 40;
    ctx.fillText(`ಗ್ರಾಮ :- ${village}`, dx, dy);
    dy += 40;
    ctx.fillText(`ಜಿಲ್ಲೆ :- ${district}`, dx, dy);

    /* DATE */
    ctx.font = "bold 22px Arial";
    ctx.fillText(
      new Date().toLocaleDateString("en-GB"),
      canvas.width - 180,
      canvas.height - 40
    );

    canvas.style.display = "block";
    downloadBtn.style.display = "block";
  };
}

/* MOBILE SAFE DOWNLOAD */
function downloadImage() {
  const dataURL = canvas.toDataURL("image/png");
  const win = window.open();
  win.document.write(`<img src="${dataURL}" style="width:100%">`);
}
</script>

</body>
</html>
